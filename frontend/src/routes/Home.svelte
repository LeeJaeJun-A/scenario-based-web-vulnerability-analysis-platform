<script>
  import fastapi from "../lib/api";
  import { termsAccepted } from '../stores';
  import { get } from 'svelte/store';
  import { link, push } from 'svelte-spa-router'

  let url = "";
  let selectedVulnerabilities = [];
  let showVulnerabilities = false;

  let selectedOptions = {
    jutongi: false,
    owasp: false,
    cve: false
  };

  let vulnerabilities = {
    ADMINISTRATOR_PAGE_EXPOSURE: false,
    AUTOMATED_ATTACK_VULNERABILITIES: false,
    BUFFER_OVERFLOW: false,
    COOKIE_MODIFICATION: false,
    CSRF: false,
    DIRECTORY_INDEXING: false,
    FORMAT_STRING: false,
    INSUFFICIENT_AUTHENTICATION: false,
    INSUFFICIENT_AUTHORIZATION: false,
    INSUFFICIENT_SESSION_EXPIRATION: false,
    LDAP_INJECTION: false,
    LOCATION_DISCLOSURE: false,
    MALICIOUS_CONTENT: false,
    MISSING_PROCESS_VALIDATION: false,
    PLAIN_TEXT_TRANSFER: false,
    ROUTE_TRACKING: false,
    RUN_OS_COMMAND: false,
    SESSION_FIXATION: false,
    SESSION_PREDICTION: false,
    SQL_INJECTION: false,
    SSI_INJECTION: false,
    SSRF: false,
    WEAK_STRING_STRENGTH: false,
    XPATH_INJECTION: false,
    XSS: false
  };

  const optionVulnerabilities = {
      jutongi: [
        'ADMINISTRATOR_PAGE_EXPOSURE',
        'AUTOMATED_ATTACK_VULNERABILITIES',
        'BUFFER_OVERFLOW',
        'COOKIE_MODIFICATION',
        'CSRF',
        'DIRECTORY_INDEXING',
        'FORMAT_STRING',
        'INSUFFICIENT_AUTHENTICATION',
        'INSUFFICIENT_AUTHORIZATION',
        'INSUFFICIENT_SESSION_EXPIRATION',
        'LDAP_INJECTION',
        'LOCATION_DISCLOSURE',
        'MALICIOUS_CONTENT',
        'MISSING_PROCESS_VALIDATION',
        'PLAIN_TEXT_TRANSFER',
        'ROUTE_TRACKING',
        'RUN_OS_COMMAND',
        'SESSION_FIXATION',
        'SESSION_PREDICTION',
        'SQL_INJECTION',
        'SSI_INJECTION',
        'SSRF',
        'WEAK_STRING_STRENGTH',
        'XPATH_INJECTION',
        'XSS'
      ],
      owasp: ['SSRF', 'XPATH_INJECTION', 'SSI_INJECTION', 'SQL_INJECTION','LDAP_INJECTION'],
      cve: []
  };

  function toggleOption(option) {
    selectedOptions[option] = !selectedOptions[option];
    
    optionVulnerabilities[option].forEach(vul => {
      vulnerabilities[vul] = selectedOptions[option];
    });
    
    if(selectedOptions.jutongi){
      optionVulnerabilities['jutongi'].forEach(vul => {
      vulnerabilities[vul] = true;
      });
    }
    
    if(selectedOptions.owasp){
      optionVulnerabilities['owasp'].forEach(vul => {
        vulnerabilities[vul] = true;
      });
    }

    if(selectedOptions.cve){
      optionVulnerabilities['cve'].forEach(vul => {
      vulnerabilities[vul] = true;
      });
    }
  }

  function toggleVulnerability(vul) {
    vulnerabilities[vul] = !vulnerabilities[vul];
  }

  function handleSubmit(event) {
    event.preventDefault();
    if (!get(termsAccepted)) {
      alert('약관에 동의해야 검사를 진행할 수 있습니다.');
      return;
    }

    const params = new URLSearchParams();
    params.append("url", url);

    selectedVulnerabilities = [];
    Object.keys(vulnerabilities).forEach(vul => {
      if (vulnerabilities[vul]) {
        selectedVulnerabilities.push(vul);
      }
    });

    if(selectedVulnerabilities.length === 0){
      alert('적어도 하나의 취약점을 선택해야 합니다.');
      return;
    }

    params.append("vulnerabilities", selectedVulnerabilities.join(","));

    push(`/analysis?${params.toString()}`);
  }

  function showOptions() {
    showVulnerabilities = !showVulnerabilities;
  }
</script>

<style>
  @import url("https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap");

  .container {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    margin-top: 50px;
  }

  header {
    text-align: center;
    margin-bottom: 30px;
  }

  header h1 {
    font-size: 24px;
    color: #333;
  }

  .form-group {
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
  }

  label {
    display: block;
    margin-bottom: 5px;
    color: #333;
  }

  input[type="text"],
  select {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .btn {
    display: block;
    width: 100%;
    padding: 10px 0;
    margin-top: 20px;
    background-color: #0047ab;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    font-size: 16px;
    text-align: center;
  }

  .btn:hover {
    background-color: #003580;
  }

  .vulnerability-list {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
  }

  .vulnerability-item {
    box-sizing: border-box;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center; /* Center content horizontally */
    height: 100px; /* Set a fixed height */
    cursor: pointer; /* Make it clear that it's clickable */
    background-color: white; /* Default background color */
    border: none; /* Remove default border */
  }

  .vulnerability-item.selected {
    background-color: #0047ab; /* Background color when selected */
    color: white; /* Text color when selected */
  }

  .Terms {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }

  .Terms label {
    margin-left: 10px;
  }

  .btn-option {
    flex: 1;
    padding: 10px 20px;
    margin-right: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #f0f0f0;
    cursor: pointer;
    font-size: 16px;
    text-align: center;
  }

  .btn-option:last-child {
    margin-right: 0;
  }

  .btn-option.selected {
    background-color: #0047ab;
    color: white;
  }
</style>

<div class="container">
  <header>
    <h1>시나리오 기반 AI 웹 취약점 분석</h1>
    <form on:submit={handleSubmit} id="main-form">
      <div class="form-group">
        <input type="text" id="url-input" bind:value={url} placeholder="URL을 입력하세요" required/>
      </div>
      <div class="Terms">
        <input type="checkbox" id="Terms" bind:checked={$termsAccepted}/>
        <label for="Terms">허가 받지 않은 분석 시도는 처벌받을 수 있습니다. 사이트 관계자인 경우에만 검사를 진행하세요.</label>
        <a href="/terms" use:link>약관 보기</a>
      </div>
      <div class="form-group">
        <button type="button" class="btn-option {selectedOptions.jutongi ? 'selected' : ''}" on:click={() => toggleOption('jutongi')}>
          주요정보통신기반시설
        </button>
        <button type="button" class="btn-option {selectedOptions.owasp ? 'selected' : ''}" on:click={() => toggleOption('owasp')}>
          OWASP Top10
        </button>
        <button type="button" class="btn-option {selectedOptions.cve ? 'selected' : ''}" on:click={() => toggleOption('cve')}>
          CVE
        </button>
      </div>
      <label for="preset-select">추가 분석 옵션 선택</label>
      <div class="form-group">
        <button type="button" id="custom-select" on:click={showOptions}>
          추가 옵션 보기
        </button>
      </div>
      {#if showVulnerabilities}
        <div class="vulnerability-list">
          <button type="button" class="vulnerability-item {vulnerabilities.ADMINISTRATOR_PAGE_EXPOSURE ? 'selected' : ''}" on:click={() => toggleVulnerability('ADMINISTRATOR_PAGE_EXPOSURE')}>
            관리자 페이지 노출
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.AUTOMATED_ATTACK_VULNERABILITIES ? 'selected' : ''}" on:click={() => toggleVulnerability('AUTOMATED_ATTACK_VULNERABILITIES')}>
            자동화 공격
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.BUFFER_OVERFLOW ? 'selected' : ''}" on:click={() => toggleVulnerability('BUFFER_OVERFLOW')}>
            Buffer Overflow
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.COOKIE_MODIFICATION ? 'selected' : ''}" on:click={() => toggleVulnerability('COOKIE_MODIFICATION')}>
            쿠키 변조
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.CSRF ? 'selected' : ''}" on:click={() => toggleVulnerability('CSRF')}>
            CSRF
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.DIRECTORY_INDEXING ? 'selected' : ''}" on:click={() => toggleVulnerability('DIRECTORY_INDEXING')}>
            Directory Indexing
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.FORMAT_STRING ? 'selected' : ''}" on:click={() => toggleVulnerability('FORMAT_STRING')}>
            Format String
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.INSUFFICIENT_AUTHENTICATION ? 'selected' : ''}" on:click={() => toggleVulnerability('INSUFFICIENT_AUTHENTICATION')}>
            불충분한 인증
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.INSUFFICIENT_AUTHORIZATION ? 'selected' : ''}" on:click={() => toggleVulnerability('INSUFFICIENT_AUTHORIZATION')}>
            불충분한 인가
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.INSUFFICIENT_SESSION_EXPIRATION ? 'selected' : ''}" on:click={() => toggleVulnerability('INSUFFICIENT_SESSION_EXPIRATION')}>
            불충분한 세션 만료
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.LDAP_INJECTION ? 'selected' : ''}" on:click={() => toggleVulnerability('LDAP_INJECTION')}>
            LDAP Injection
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.LOCATION_DISCLOSURE ? 'selected' : ''}" on:click={() => toggleVulnerability('LOCATION_DISCLOSURE')}>
            위치 공개
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.MALICIOUS_CONTENT ? 'selected' : ''}" on:click={() => toggleVulnerability('MALICIOUS_CONTENT')}>
            악성 콘텐츠
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.MISSING_PROCESS_VALIDATION ? 'selected' : ''}" on:click={() => toggleVulnerability('MISSING_PROCESS_VALIDATION')}>
            프로세스 검증 누락
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.PLAIN_TEXT_TRANSFER ? 'selected' : ''}" on:click={() => toggleVulnerability('PLAIN_TEXT_TRANSFER')}>
            데이터 평문 전송
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.ROUTE_TRACKING ? 'selected' : ''}" on:click={() => toggleVulnerability('ROUTE_TRACKING')}>
            경로 추적
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.RUN_OS_COMMAND ? 'selected' : ''}" on:click={() => toggleVulnerability('RUN_OS_COMMAND')}>
            운영체제 명령 실행
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.SESSION_FIXATION ? 'selected' : ''}" on:click={() => toggleVulnerability('SESSION_FIXATION')}>
            세션 고정
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.SESSION_PREDICTION ? 'selected' : ''}" on:click={() => toggleVulnerability('SESSION_PREDICTION')}>
            세션 예측
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.SQL_INJECTION ? 'selected' : ''}" on:click={() => toggleVulnerability('SQL_INJECTION')}>
            SQL Injection
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.SSI_INJECTION ? 'selected' : ''}" on:click={() => toggleVulnerability('SSI_INJECTION')}>
            SSI Injection
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.SSRF ? 'selected' : ''}" on:click={() => toggleVulnerability('SSRF')}>
            SSRF
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.WEAK_STRING_STRENGTH ? 'selected' : ''}" on:click={() => toggleVulnerability('WEAK_STRING_STRENGTH')}>
            약한 문자열 강도
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.XPATH_INJECTION ? 'selected' : ''}" on:click={() => toggleVulnerability('XPATH_INJECTION')}>
            XPath Injection
          </button>
          <button type="button" class="vulnerability-item {vulnerabilities.XSS ? 'selected' : ''}" on:click={() => toggleVulnerability('XSS')}>
            XSS
          </button>
        </div>
      {/if}
      <button type="submit" class="btn">분석 시작</button>
    </form>
  </header>
</div>
