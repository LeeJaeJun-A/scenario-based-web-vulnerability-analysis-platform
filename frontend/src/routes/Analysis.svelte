<script>
  import { onMount } from 'svelte';
  import { push } from 'svelte-spa-router'
  import fastapi from "../lib/api"

  const VITE_SERVER_URL = import.meta.env.VITE_SERVER_URL;

  let url;
  let selectedVulnerabilities;
  let progress = 0;
  let completedChecks = [];
  let socket;
  let websocketId = Math.random().toString(36).substring(7); // Random ID for the WebSocket

  function startAnalysis() {
    fastapi('post', '/analysis', {url: url, selectedVulnerabilities: selectedVulnerabilities}, 
      (json) => {
        console.log('Analysis started');
      },
      (json_error) => {
        console.error('Error starting analysis', json_error);
      },
      { 'websocket_id': websocketId }
    );
  }

  function setupWebSocket() {
    socket = new WebSocket(`${VITE_SERVER_URL.replace('http', 'ws')}/ws/${websocketId}`);
    
    socket.onopen = function(event) {
      console.log('WebSocket is open now.');
      startAnalysis();
    };

    socket.onmessage = function(event) {
      let message = JSON.parse(event.data);
      if (message.status === 'All analysis completed') {
        const queryParams = new URLSearchParams({
          url: url
        }).toString();
        push(`/result?${queryParams}`);
      } else {
        completedChecks = [...completedChecks, `${message.time} - ${message.vulnerability} - ${message.status}`];
        progress = (completedChecks.length / selectedVulnerabilities.length) * 100;
      }
    };

    socket.onclose = function(event) {
      console.log('WebSocket is closed now.');
    };
  }
  
  function getQueryParams(hash) {
    const params = new URLSearchParams(hash.split('?')[1]);
    return {
      url: params.get('url'),
      vulnerabilities: params.get('vulnerabilities')
    };
  }

  onMount(() => {
    const queryParams = getQueryParams(window.location.hash);
    url = queryParams.url;
    selectedVulnerabilities = JSON.parse(queryParams.vulnerabilities);
    setupWebSocket();
  });
</script>
  
<style>
    .container {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin-top: 50px;
      font-family: "Orbitron", sans-serif;
    }
  
    .progress-bar {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 25px;
      margin: 20px 0;
    }
  
    .progress-bar-inner {
      height: 25px;
      width: 0;
      background-color: #76c7c0;
      border-radius: 25px;
      text-align: center;
      line-height: 25px;
      color: white;
    }
  
    .completed-checks {
      margin-top: 20px;
    }
  
    .completed-check {
      margin-bottom: 10px;
    }
</style>
  
<div class="container">
    <h1>분석 진행 중...</h1>

    <div class="progress-bar">
        <div class="progress-bar-inner" style="width: {progress}%;">
        {Math.round(progress)}%
        </div>
    </div>

    <div class="completed-checks">
        {#each completedChecks as check}
        <div class="completed-check">{check}</div>
        {/each}
    </div>
</div>
  